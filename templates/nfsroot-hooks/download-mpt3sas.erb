#!/bin/bash
################################################################################
# <%= scope.lookupvar('fai::params::nfsroot_hookdir') %>/20-download-mpt3sas
#
#       _   _ _____ ____  ____   ___   ___ _____   _   _             _
#      | \ | |  ___/ ___||  _ \ / _ \ / _ \_   _| | | | | ___   ___ | | __
#      |  \| | |_  \___ \| |_) | | | | | | || |   | |_| |/ _ \ / _ \| |/ /
#      | |\  |  _|  ___) |  _ <| |_| | |_| || |   |  _  | (_) | (_) |   <
#      |_| \_|_|   |____/|_| \_\\___/ \___/ |_|   |_| |_|\___/ \___/|_|\_\
#
################################################################################
# Shell scripts to be sourced at the end of make-fai-nfsroot for additional
# configuration of the nfsroot - here the reconfiguration of the initrd to
# include a set of kernel modules (network card typically)
################################################################################
# /!\ DO NOT EDIT THIS FILE: it has been automatically generated by Puppet.
#      In particular, any further changes will be overwritten at the next
#      puppet invocation
################################################################################

echo "*** Enter download-mpt3sas hook ***"

TARGET_KERNEL_VERSION=`basename ${NFSROOT}/boot/initrd.img-* | sed "s/initrd\.img-//"`
echo "target kernel = ${TARGET_KERNEL_VERSION}"
MISCDIR=/lib/modules/${TARGET_KERNEL_VERSION}/misc
${ROOTCMD} mkdir $MISCDIR

echo "=> downloading module: mpt3sas"
MODFILE="${NFSROOT}/${MISCDIR}/mpt3sas.ko"
wget -q https://www.dropbox.com/s/60n7i71d3aq3djv/mpt3sas.ko -O "${MODFILE}"

sha256sum -c <<< "ddb85243dfc93cac9bf657616c5ae25c5f952a169c046f5486090ecfb3315077  $MODFILE"

if [[ "$?" != 0 ]] ; then
  rm -f $MODFILE
  exit 1
else
  echo "=> Integrity check passed"
fi

