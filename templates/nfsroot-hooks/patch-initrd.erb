#!/bin/bash
################################################################################
# <%= scope.lookupvar('fai::params::nfsroot_hookdir') %>/30-patch-initrd
#
#       _   _ _____ ____  ____   ___   ___ _____   _   _             _
#      | \ | |  ___/ ___||  _ \ / _ \ / _ \_   _| | | | | ___   ___ | | __
#      |  \| | |_  \___ \| |_) | | | | | | || |   | |_| |/ _ \ / _ \| |/ /
#      | |\  |  _|  ___) |  _ <| |_| | |_| || |   |  _  | (_) | (_) |   <
#      |_| \_|_|   |____/|_| \_\\___/ \___/ |_|   |_| |_|\___/ \___/|_|\_\
#
################################################################################
# Shell scripts to be sourced at the end of make-fai-nfsroot for additional
# configuration of the nfsroot - here the reconfiguration of the initrd to
# include a set of kernel modules (network card typically)
################################################################################
# /!\ DO NOT EDIT THIS FILE: it has been automatically generated by Puppet.
#      In particular, any further changes will be overwritten at the next
#      puppet invocation
################################################################################

echo "*** Enter patch initrd hook ***"

TARGET_KERNEL_VERSION=`basename $(ls -1 ${NFSROOT}/boot/initrd.img-* | grep -v old-dkms | tail -n 1) | sed "s/initrd\.img-//"`
echo "target kernel = ${TARGET_KERNEL_VERSION}"
INITRDFILE="/boot/initrd.img-${TARGET_KERNEL_VERSION}"
MISCDIR=/lib/modules/${TARGET_KERNEL_VERSION}/misc

<% if scope.lookupvar('fai::use_backports') == true -%>
$ROOTCMD apt-get install -t <%= scope.lookupvar('fai::debootstrap_suite') %>-backports firmware-bnx2
<% end -%>

<% if scope.lookupvar('fai::initramfs_modules') != [] -%>
echo "=> add the following modules to the initrd: <%= scope.lookupvar('fai::initramfs_modules').join(',') %>"
cat >> ${NFSROOT}/etc/dracut.conf.d/30-modules.conf <<EOF
# Custom modules added by the NFSROOK hook
add_drivers+="<% scope.lookupvar('fai::initramfs_modules').each do |modu| -%><%= modu %> <% end -%>"
EOF

${ROOTCMD} depmod -a


if [ -f "${NFSROOT}/${INITRDFILE}" ]; then
    echo "=> removing ${NFSROOT}/${INITRDFILE}"
    rm -f ${NFSROOT}/${INITRDFILE}

    echo "=> updating initramfs for the nfsroot"
    $ROOTCMD dracut -f ${INITRDFILE}

    echo "=> updating ${TFTPROOT}/initrd.img-*"
    cp ${NFSROOT}/boot/initrd.img-* ${TFTPROOT}/
else
    echo "/!\ WARNING: unable to find the file '${NFSROOT}/${INITRDFILE}'"
fi

<% end -%>

# echo "Exit patch initrd hook"



