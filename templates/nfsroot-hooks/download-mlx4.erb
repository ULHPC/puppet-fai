#!/bin/bash
################################################################################
# <%= scope.lookupvar('fai::params::nfsroot_hookdir') %>/21-download-mlx4
#
#       _   _ _____ ____  ____   ___   ___ _____   _   _             _
#      | \ | |  ___/ ___||  _ \ / _ \ / _ \_   _| | | | | ___   ___ | | __
#      |  \| | |_  \___ \| |_) | | | | | | || |   | |_| |/ _ \ / _ \| |/ /
#      | |\  |  _|  ___) |  _ <| |_| | |_| || |   |  _  | (_) | (_) |   <
#      |_| \_|_|   |____/|_| \_\\___/ \___/ |_|   |_| |_|\___/ \___/|_|\_\
#
################################################################################
# Shell scripts to be sourced at the end of make-fai-nfsroot for additional
# configuration of the nfsroot - here the reconfiguration of the initrd to
# include a set of kernel modules (network card typically)
################################################################################
# /!\ DO NOT EDIT THIS FILE: it has been automatically generated by Puppet.
#      In particular, any further changes will be overwritten at the next
#      puppet invocation
################################################################################

echo "*** Enter download-mlx4 hook ***"

mkdir ${NFSROOT}/tmp/mlx
cd ${NFSROOT}/tmp/mlx
echo "=> downloading mellanox debs"

wget -q https://www.dropbox.com/s/y80eyb7ccbgawkv/mlnx-en-dkms_3.0-1.0.1.0.gb558788_all.deb
wget -q https://www.dropbox.com/s/k9ym7sd2t6g2udg/mlnx-en-utils_3.0-1.0.1.0.gb558788_amd64.deb



sha256sum -c <<< "0ed93c4b338736ab8cc63b7d0986feeda294def70063f5155ff780877d9c2faa  mlnx-en-dkms_3.0-1.0.1.0.gb558788_all.deb
                  0191059bb6be28a2de406fb5d827cb09a36add05c1932a70676ad91721cbd5ad  mlnx-en-utils_3.0-1.0.1.0.gb558788_amd64.deb"

if [[ "$?" != 0 ]] ; then
  echo "=> Integrity check failed, exiting"
  exit 1
else
  echo "=> Integrity check passed"
fi


echo "=> installing prerequisites"
${ROOTCMD} apt-get install -y lsb-release dkms make linux-headers-amd64

echo "=> installing mellanox debs"
${ROOTCMD} dpkg -i /tmp/mlx/mlnx-en-utils_3.0-1.0.1.0.gb558788_amd64.deb
${ROOTCMD} dpkg -i /tmp/mlx/mlnx-en-dkms_3.0-1.0.1.0.gb558788_all.deb
